
{% extends "base.html" %}

{% block title %}Announcement - Chatbot Admin{% endblock %}
{% block page_title %}Announcement{% endblock %}

{% block content %}
<div class="announcement-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0;">Pengumuman Sistem</h2>
        <button class="btn btn-primary" onclick="showAddForm()">
            <i class="fas fa-plus"></i> Buat Pengumuman Baru
        </button>
    </div>

    <div id="announcementsList" style="margin-bottom: 24px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
        <div style="text-align: center; padding: 40px; color: #a0aec0; grid-column: 1 / -1;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
            <p>Memuat pengumuman...</p>
        </div>
    </div>
</div>

<!-- Modal for Add/Edit Announcement -->
<div id="announcementModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="formTitle">Buat Pengumuman Baru</h3>
            <span class="close" onclick="hideModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="announcementForm">
                <input type="hidden" id="editingId" value="">
                <div class="form-group">
                    <label for="title">Judul *</label>
                    <input type="text" class="form-control" id="title" required placeholder="Masukkan judul pengumuman">
                </div>
                <div class="form-group">
                    <label for="message">Pesan *</label>
                    <textarea class="form-control" id="message" required rows="6" placeholder="Masukkan isi pengumuman"></textarea>
                </div>
                <div class="form-group">
                    <label for="category">Kategori *</label>
                    <select class="form-control" id="category" required>
                        <option value="Umum">Umum</option>
                        <option value="Penting">Penting</option>
                        <option value="Akademik">Akademik</option>
                        <option value="Info">Info</option>
                        <option value="Peraturan">Peraturan</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" onclick="hideModal()">Batal</button>
            <button type="submit" form="announcementForm" class="btn btn-primary">
                <span id="saveButtonText">Simpan Pengumuman</span>
                <span id="saveButtonLoading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Menyimpan...
                </span>
            </button>
        </div>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
}

.modal-content {
    background-color: #1a1f2e;
    margin: 5% auto;
    border: 1px solid #2d3748;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #2d3748;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: #fff;
    font-size: 1.25rem;
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #2d3748;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.close {
    color: #a0aec0;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s;
}

.close:hover,
.close:focus {
    color: #fff;
}

.announcement-card {
    background-color: #1a1f2e;
    border: 1px solid #2d3748;
    border-radius: 8px;
    padding: 20px;
}

.announcement-card h4 {
    color: #fff;
    margin-bottom: 10px;
    font-size: 1rem;
    font-weight: 600;
}

.announcement-card p {
    color: #a0aec0;
    line-height: 1.6;
    margin-bottom: 16px;
    white-space: pre-wrap;
}

.announcement-card .meta {
    color: #718096;
    font-size: 0.85rem;
    margin-bottom: 16px;
}

.announcement-card .actions {
    display: flex;
    gap: 8px;
}

.btn-secondary {
    background-color: #2d3748;
    color: #fff;
    border: 1px solid #4a5568;
}

.btn-secondary:hover {
    background-color: #374151;
}

.btn-danger {
    background-color: #dc2626;
    color: #fff;
    border: 1px solid #dc2626;
}

.btn-danger:hover {
    background-color: #b91c1c;
}

.btn-sm {
    padding: 8px 14px;
    font-size: 0.875rem;
}

.category-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 8px;
}

.category-penting {
    background-color: #e53e3e;
    color: #fff;
}

.category-akademik {
    background-color: #3182ce;
    color: #fff;
}

.category-umum {
    background-color: #718096;
    color: #fff;
}

.category-info {
    background-color: #38b2ac;
    color: #fff;
}

.category-peraturan {
    background-color: #d69e2e;
    color: #fff;
}

@media (max-width: 768px) {
    #announcementsList {
        grid-template-columns: 1fr !important;
    }
    
    .announcement-card .actions {
        flex-direction: column;
    }
    
    .announcement-card .actions .btn {
        width: 100%;
    }
}
</style>

<script>
let currentEditingId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadAnnouncements();
});

function loadAnnouncements() {
    fetch('/api/announcement/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAnnouncements(data.data);
            } else {
                showError('Gagal memuat pengumuman');
            }
        })
        .catch(error => {
            console.error('Error loading announcements:', error);
            showError('Terjadi kesalahan saat memuat pengumuman');
        });
}

function displayAnnouncements(announcements) {
    const container = document.getElementById('announcementsList');
    
    if (announcements.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #a0aec0; grid-column: 1 / -1;">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px;"></i>
                <p>Belum ada pengumuman. Klik "Buat Pengumuman Baru" untuk membuat yang pertama.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = announcements.map(announcement => {
        const createdDate = new Date(announcement.created_at).toLocaleString('id-ID', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Asia/Jakarta'
        });
        
        const category = announcement.category || 'Umum';
        const categoryClass = 'category-' + category.toLowerCase();
        const borderColor = getCategoryBorderColor(category);
        
        return `
            <div class="announcement-card">
                <div class="category-badge ${categoryClass}">${category}</div>
                <h4>${escapeHtml(announcement.title)}</h4>
                <p>${escapeHtml(announcement.message)}</p>
                <div class="meta">${createdDate}</div>
                <div class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="editAnnouncement('${announcement.id}')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteAnnouncement('${announcement.id}', '${escapeHtml(announcement.title)}')">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function getCategoryBorderColor(category) {
    const colors = {
        'Penting': '#e53e3e',
        'Akademik': '#3182ce',
        'Umum': '#718096',
        'Info': '#38b2ac',
        'Peraturan': '#d69e2e'
    };
    return colors[category] || '#3182ce';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showAddForm() {
    document.getElementById('formTitle').textContent = 'Buat Pengumuman Baru';
    document.getElementById('editingId').value = '';
    document.getElementById('title').value = '';
    document.getElementById('message').value = '';
    document.getElementById('category').value = 'Umum';
    document.getElementById('saveButtonText').textContent = 'Simpan Pengumuman';
    document.getElementById('announcementModal').style.display = 'block';
    setTimeout(() => document.getElementById('title').focus(), 100);
}

function hideModal() {
    document.getElementById('announcementModal').style.display = 'none';
    document.getElementById('announcementForm').reset();
    document.getElementById('editingId').value = '';
}

function editAnnouncement(id) {
    fetch(`/api/announcement/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('formTitle').textContent = 'Edit Pengumuman';
                document.getElementById('editingId').value = id;
                document.getElementById('title').value = data.data.title;
                document.getElementById('message').value = data.data.message;
                document.getElementById('category').value = data.data.category || 'Umum';
                document.getElementById('saveButtonText').textContent = 'Update Pengumuman';
                document.getElementById('announcementModal').style.display = 'block';
                setTimeout(() => document.getElementById('title').focus(), 100);
            } else {
                showError('Gagal memuat data pengumuman');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Terjadi kesalahan');
        });
}

function deleteAnnouncement(id, title) {
    if (!confirm(`Apakah Anda yakin ingin menghapus pengumuman "${title}"?`)) {
        return;
    }
    
    fetch(`/api/announcement/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Pengumuman berhasil dihapus!');
            loadAnnouncements();
        } else {
            showError('Gagal menghapus pengumuman: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Terjadi kesalahan');
    });
}

function showSaveLoading() {
    document.getElementById('saveButtonText').style.display = 'none';
    document.getElementById('saveButtonLoading').style.display = 'inline';
    document.querySelector('button[type="submit"]').disabled = true;
}

function resetSaveButton() {
    document.getElementById('saveButtonText').style.display = 'inline';
    document.getElementById('saveButtonLoading').style.display = 'none';
    document.querySelector('button[type="submit"]').disabled = false;
}

function showSuccess(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #48bb78;
        color: #fff;
        padding: 15px 20px;
        border-radius: 5px;
        z-index: 10000;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        document.body.removeChild(notification);
    }, 3000);
}

function showError(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #e53e3e;
        color: #fff;
        padding: 15px 20px;
        border-radius: 5px;
        z-index: 10000;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        document.body.removeChild(notification);
    }, 5000);
}

document.getElementById('announcementForm').addEventListener('submit', function(e) {
    e.preventDefault();

    showSaveLoading();

    const editingId = document.getElementById('editingId').value;
    const formData = {
        title: document.getElementById('title').value,
        message: document.getElementById('message').value,
        category: document.getElementById('category').value
    };

    const url = editingId ? `/api/announcement/${editingId}` : '/api/announcement/';
    const method = editingId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        resetSaveButton();
        if (data.success) {
            const message = editingId ? 'Pengumuman berhasil diupdate!' : 'Pengumuman berhasil dibuat!';
            showSuccess(message);
            hideModal();
            loadAnnouncements();
        } else {
            showError('Gagal menyimpan pengumuman: ' + data.error);
        }
    })
    .catch(error => {
        resetSaveButton();
        showError('Terjadi kesalahan: ' + error.message);
    });
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('announcementModal');
    if (event.target === modal) {
        hideModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('announcementModal').style.display === 'block') {
        hideModal();
    }
});
</script>
{% endblock %}
